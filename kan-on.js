/* æ¨å°æ—¥èªæ¼¢éŸ³
 *
 * èª¬æ˜
 * ä»¥ä¸‹ä»£ç¢¼çˆ²ç”Ÿæˆæ¨å°æ—¥èªæ¼¢éŸ³çš„å‡½æ•¸é«”
 * 
 * ä»¥å­—éŸ³å‡åé£å½¢å¼è¡¨ç¤ºï¼Œæ‹—éŸ³ç”¨å°æ‡‰çš„å°å‡åè¡¨ç¤º
 * 
 * æœ‰é–‹é—œå¯æ§åˆ¶ï¼š-m -n ä¹‹åˆ†ã€-wi -we åˆæ‹—éŸ³ã€wiwe å°å‡åè¡¨ç¤ºã€ç‹‚ ã‚¯ğ›…¥ãƒ£ã‚¦ vs ã‚­ãƒ£ã‚¦
 * 
 * å‡½æ•¸æ¥å—éŸ³éŸ»åœ°ä½ï¼Œè¿”å›å°æ‡‰çš„æ¨å°æ—¥èªæ¼¢éŸ³
 * 
 */

const is = (x) => éŸ³éŸ»åœ°ä½.å±¬æ–¼(x);

const é–‹é—œ = {};

é–‹é—œ.å‡å = true; // é–‹ï¼šã‚«ãƒ³ã€€é—œï¼škan
é–‹é—œ.å°å‡å = true; // é–‹ï¼šã‚­ãƒ£ã‚¦ã€€é—œï¼šã‚­ãƒ¤ã‚¦

é–‹é—œ.åˆ†mn = true; // é–‹ï¼šã‚µãƒ ã€€é—œï¼šã‚µãƒ³

é–‹é—œ.wiwe = true; // é–‹ï¼šã‚¯ğ›…¥ãƒ³ã€€é—œï¼šã‚±ãƒ³
é–‹é—œ.å°å‡åwiwe = true; // é–‹ï¼šã‚¯ğ›…¥ãƒ³ã€€é—œï¼šã‚¯ãƒ±ãƒ³
é–‹é—œ.kwiyau = true; // é–‹ï¼šã‚¯ğ›…¥ãƒ£ã‚¦ã€€é—œï¼šã‚­ãƒ£ã‚¦

if (!é–‹é—œ.å°å‡å)
    é–‹é—œ.å°å‡åwiwe = false;

function è²æ¯è¦å‰‡() {
    switch (éŸ³éŸ»åœ°ä½.æ¯) {
        case 'å¹«': return 'f';
        case 'æ»‚': return 'f';
        case 'ä¸¦': return 'f';
        case 'æ˜': return 'm';
        case 'ç«¯': return 't';
        case 'é€': return 't';
        case 'å®š': return 't';
        case 'æ³¥': return 'd';
        case 'çŸ¥': return 't';
        case 'å¾¹': return 't';
        case 'æ¾„': return 't';
        case 'å­ƒ': return 'd';
        case 'ç²¾': return 's';
        case 'æ¸…': return 's';
        case 'å¾': return 's';
        case 'å¿ƒ': return 's';
        case 'é‚ª': return 's';
        case 'èŠ': return 's';
        case 'åˆ': return 's';
        case 'å´‡': return 's';
        case 'ç”Ÿ': return 's';
        case 'ä¿Ÿ': return 's';
        case 'ç« ': return 's';
        case 'æ˜Œ': return 's';
        case 'èˆ¹': return 's';
        case 'æ›¸': return 's';
        case 'å¸¸': return 's';
        case 'è¦‹': return 'k';
        case 'æºª': return 'k';
        case 'ç¾£': return 'k';
        case 'ç–‘': return 'g';
        case 'å½±': return '0';
        case 'æ›‰': return 'k';
        case 'åŒ£': return 'k';
        case 'äº‘': return '0';
        case 'ä»¥': return '0';
        case 'ä¾†': return 'r';
        case 'æ—¥': return 'z';
        default: throw new Error('ç„¡è²æ¯è¦å‰‡');
    }
}

function éŸ»æ¯è¦å‰‡() {
	// æœæ”
	if (is('é–‹å£ ä¸€ç­‰ æ­ŒéŸ»')) return 'a';
	if (is('é–‹å£ ä¸‰ç­‰ æˆˆéŸ»')) return 'a';
	if (is('åˆå£ ä¸€ç­‰ æˆˆéŸ»')) return 'wa';
	if (is('åˆå£ ä¸‰ç­‰ æˆˆéŸ»')) return 'wa';
	// å‡æ”
	if (is('é–‹å£ äºŒç­‰ éº»éŸ»')) return 'a';
	if (is('é–‹å£ ä¸‰ç­‰ éº»éŸ»')) return 'ya';
	if (is('åˆå£ äºŒç­‰ éº»éŸ»')) return 'wa';
	// é‡æ”
	if (is('ä¸€ç­‰ æ¨¡éŸ»')) return 'o';
	if (is('ä¸‰ç­‰ é­šéŸ»')) return is('èŠçµ„') ? 'o' : 'yo';
	if (is('ä¸‰ç­‰ è™éŸ»')) return is('å¹«è¦‹å½±çµ„') ? 'u' : (is('çŸ¥çµ„') ? 'yuu' : 'yu');
	// èŸ¹æ”
	if (is('é–‹å£ ä¸€ç­‰ å’éŸ»')) return 'ai';
	if (is('é–‹å£ äºŒç­‰ ä½³éŸ»')) return 'ai';
	if (is('é–‹å£ äºŒç­‰ çš†éŸ»')) return 'ai';
	if (is('é–‹å£ å››ç­‰ é½ŠéŸ»')) return 'ei';
	if (is('é–‹å£ ä¸€ç­‰ æ³°éŸ»')) return 'ai';
	if (is('é–‹å£ äºŒç­‰ å¤¬éŸ»')) return 'ai';
	if (is('é–‹å£ ä¸‰ç­‰ ç¥­éŸ»')) return 'ei';
	if (is('é–‹å£ ä¸‰ç­‰ å»¢éŸ»')) return 'ai';
	if (is('åˆå£ ä¸€ç­‰ ç°éŸ»')) return 'wai';
	if (is('åˆå£ äºŒç­‰ ä½³éŸ»')) return 'wai';
	if (is('åˆå£ äºŒç­‰ çš†éŸ»')) return 'wai';
	if (is('åˆå£ å››ç­‰ é½ŠéŸ»')) return 'wei';
	if (is('åˆå£ ä¸€ç­‰ æ³°éŸ»')) return 'wai';
	if (is('åˆå£ äºŒç­‰ å¤¬éŸ»')) return 'wai';
	if (is('åˆå£ ä¸‰ç­‰ ç¥­éŸ»')) return 'wei';
	if (is('åˆå£ ä¸‰ç­‰ å»¢éŸ»')) return 'wai';
	// æ­¢æ”
	if (is('é–‹å£ ä¸‰ç­‰ æ”¯éŸ»')) return 'i';
	if (is('é–‹å£ ä¸‰ç­‰ è„‚éŸ»')) return 'i';
	if (is('é–‹å£ ä¸‰ç­‰ ä¹‹éŸ»')) return 'i';
	if (is('é–‹å£ ä¸‰ç­‰ å¾®éŸ»')) return 'i';
	if (is('åˆå£ ä¸‰ç­‰ æ”¯éŸ» é‡ç´Aé¡')) return 'i';
	if (is('åˆå£ ä¸‰ç­‰ æ”¯éŸ»')) return 'wi';
	if (is('åˆå£ ä¸‰ç­‰ è„‚éŸ» é‡ç´Aé¡')) return 'i';
	if (is('åˆå£ ä¸‰ç­‰ è„‚éŸ»')) return 'wi';
	if (is('åˆå£ ä¸‰ç­‰ å¾®éŸ»')) return 'wi';
    // æ•ˆæ”
	if (is('ä¸€ç­‰ è±ªéŸ» å¹«çµ„')) return 'ou';
	if (is('ä¸€ç­‰ è±ªéŸ»')) return 'au';
	if (is('äºŒç­‰ è‚´éŸ»')) return 'au';
	if (is('ä¸‰ç­‰ å®µéŸ»')) return 'eu';
	if (is('å››ç­‰ è•­éŸ»')) return 'eu';
	// æµæ”
	if (is('ä¸€ç­‰ ä¾¯éŸ»')) return 'ou';
	if (is('ä¸‰ç­‰ å°¤éŸ»')) return is('å¹«çµ„') ? (is('æ˜æ¯') ? 'ou' : 'uu') : 'iu';
	if (is('ä¸‰ç­‰ å¹½éŸ»')) return 'iu';
	// å’¸æ”
	if (is('é–‹å£ ä¸€ç­‰ è«‡éŸ»')) return 'am';
	if (is('é–‹å£ äºŒç­‰ éŠœéŸ»')) return 'am';
	if (is('é–‹å£ äºŒç­‰ å’¸éŸ»')) return 'am';
	if (is('é–‹å£ ä¸‰ç­‰ é¹½éŸ»')) return 'em';
	if (is('é–‹å£ ä¸‰ç­‰ åš´éŸ»')) return 'em';
	if (is('é–‹å£ å››ç­‰ æ·»éŸ»')) return 'em';
	if (is('é–‹å£ ä¸€ç­‰ è¦ƒéŸ»')) return 'am';
	if (is('åˆå£ ä¸‰ç­‰ å‡¡éŸ»')) return 'am';
	// æ·±æ”
	if (is('ä¸‰ç­‰ ä¾µéŸ»')) return 'im';
	// å±±æ”
	if (is('é–‹å£ ä¸€ç­‰ å¯’éŸ»')) return 'an';
	if (is('é–‹å£ äºŒç­‰ åˆªéŸ»')) return 'an';
	if (is('é–‹å£ äºŒç­‰ å±±éŸ»')) return 'an';
	if (is('é–‹å£ ä¸‰ç­‰ ä»™éŸ»')) return 'en';
	if (is('é–‹å£ å››ç­‰ å…ˆéŸ»')) return 'en';
	if (is('åˆå£ ä¸€ç­‰ æ¡“éŸ»')) return 'wan';
	if (is('åˆå£ äºŒç­‰ åˆªéŸ»')) return 'wan';
	if (is('åˆå£ äºŒç­‰ å±±éŸ»')) return 'wan';
	if (is('åˆå£ ä¸‰ç­‰ ä»™éŸ»')) return 'wen';
	if (is('åˆå£ å››ç­‰ å…ˆéŸ»')) return 'wen';
	// è‡»æ”
	if (is('é–‹å£ ä¸€ç­‰ ç—•éŸ»')) return 'on';
	if (is('é–‹å£ ä¸‰ç­‰ çœéŸ»')) return 'in';
	if (is('é–‹å£ ä¸‰ç­‰ è‡»éŸ»')) return 'in';
	if (is('é–‹å£ ä¸‰ç­‰ æ¬£éŸ»')) return 'in';
	if (is('é–‹å£ ä¸‰ç­‰ å…ƒéŸ»')) return 'en';
	if (is('åˆå£ ä¸€ç­‰ é­‚éŸ»')) return 'on';
    if (is('åˆå£ ä¸‰ç­‰ çœéŸ»')) return 'win';
    if (is('åˆå£ ä¸‰ç­‰ è«„éŸ» é‡ç´Aé¡')) return 'in';
	if (is('åˆå£ ä¸‰ç­‰ è«„éŸ»')) return is('ä¾†æ¯') ? 'in' : 'yun';
	if (is('åˆå£ ä¸‰ç­‰ æ–‡éŸ»')) return 'un';
	if (is('åˆå£ ä¸‰ç­‰ å…ƒéŸ»')) return is('å¹«çµ„') ? 'wan' : 'wen';
	// å®•æ”
	if (is('é–‹å£ ä¸€ç­‰ å”éŸ»')) return 'aÅ‹';
	if (is('é–‹å£ ä¸‰ç­‰ é™½éŸ»')) return is('èŠçµ„') ? 'aÅ‹' : 'yaÅ‹';
	if (is('åˆå£ ä¸€ç­‰ å”éŸ»')) return 'waÅ‹';
	if (is('åˆå£ ä¸‰ç­‰ é™½éŸ»')) return is('è¦‹çµ„ æˆ– å½±æ›‰æ¯') ? 'wiyaÅ‹' : 'waÅ‹';
	// æ¢—æ”
	if (is('é–‹å£ äºŒç­‰ åºšéŸ»')) return is('è¦‹å¹«çŸ¥çµ„ æˆ– åŒ£æ¯') ? 'aÅ‹' : 'eÅ‹';
	if (is('é–‹å£ äºŒç­‰ è€•éŸ»')) return 'aÅ‹';
	if (is('é–‹å£ ä¸‰ç­‰ åºšéŸ»')) return 'eÅ‹';
	if (is('é–‹å£ ä¸‰ç­‰ æ¸…éŸ»')) return 'eÅ‹';
	if (is('é–‹å£ å››ç­‰ é’éŸ»')) return 'eÅ‹';
	if (is('åˆå£ äºŒç­‰ åºšéŸ»')) return 'waÅ‹';
	if (is('åˆå£ äºŒç­‰ è€•éŸ»')) return 'waÅ‹';
	if (is('åˆå£ ä¸‰ç­‰ åºšéŸ»')) return 'weÅ‹';
	if (is('åˆå£ ä¸‰ç­‰ æ¸…éŸ»')) return 'yeÅ‹';
	if (is('åˆå£ å››ç­‰ é’éŸ»')) return 'weÅ‹';
	// æ›¾æ”
	if (is('é–‹å£ ä¸€ç­‰ ç™»éŸ»')) return 'oÅ‹';
	if (is('é–‹å£ ä¸‰ç­‰ è’¸éŸ»')) return 'yoÅ‹';
	if (is('åˆå£ ä¸€ç­‰ ç™»éŸ»')) return 'oÅ‹';
	if (is('åˆå£ ä¸‰ç­‰ è’¸éŸ»')) return 'yoÅ‹';
	// é€šæ”
	if (is('ä¸€ç­‰ æ±éŸ»')) return 'oÅ‹';
	if (is('ä¸‰ç­‰ é¾éŸ»')) return 'yoÅ‹';
    if (is('ä¸€ç­‰ å†¬éŸ»')) return 'oÅ‹';
    if (is('ä¸‰ç­‰ æ±éŸ» å¹«çµ„')) return !is('å…¥è²') || is('æ˜æ¯') ? 'oÅ‹': 'uÅ‹';
    if (is('ä¸‰ç­‰ æ±éŸ» çŸ¥å½±çµ„')) return 'iÅ‹';
    if (is('ä¸‰ç­‰ æ±éŸ» æ—¥ä¾†ä»¥æ¯')) return 'iÅ‹';
    if (is('ä¸‰ç­‰ æ±éŸ» è¦‹çµ„ å…¥è²')) return 'iÅ‹';
	if (is('ä¸‰ç­‰ æ±éŸ»')) return 'yuÅ‹';
	// æ±Ÿæ”
	if (is('äºŒç­‰ æ±ŸéŸ»')) return 'aÅ‹';
	throw new Error('ç„¡éŸ»æ¯è¦å‰‡');
}

let è²æ¯ = è²æ¯è¦å‰‡();
let éŸ»æ¯ = éŸ»æ¯è¦å‰‡();


// == éŸ»å°¾è¦å‰‡ ==

// å…¥è²éŸ»å°¾
if (is('å…¥è²')) {
	if (éŸ»æ¯.endsWith('m')) {
		éŸ»æ¯ = éŸ»æ¯.slice(0, -1) + 'fu';
	} else if (éŸ»æ¯.endsWith('n')) {
		éŸ»æ¯ = éŸ»æ¯.slice(0, -1) + 'tu';
	} else if (éŸ»æ¯.endsWith('Å‹')) {
		éŸ»æ¯ = éŸ»æ¯.slice(0, -1) + (éŸ»æ¯[éŸ»æ¯.length - 2] == 'e' ? 'ki' : 'ku');
	}
}

// é¼»éŸ³éŸ»å°¾åŒåŒ–é¼»éŸ³è²æ¯
// NV > BV | NVN > NVN
//   ä¾‹å¤–ï¼šèšŠ ãƒ–ãƒ³ã€€NVN > NVN â†’ mun > bun
if (è²æ¯ == 'm' && (!éŸ»æ¯.endsWith('Å‹') || éŸ»æ¯.startsWith('u') || is('å”é™½æ±éŸ»'))) {
    è²æ¯ = 'b'
}

// å¾Œé¼»éŸ³éŸ»å°¾
if (éŸ»æ¯.endsWith('Å‹')) {
    éŸ»æ¯ = éŸ»æ¯.slice(0, -1) + (['e', 'i'].includes(éŸ»æ¯[éŸ»æ¯.length - 2]) ? 'i': 'u')
}

// æ±š 0o -> wo
// ç¿ 0ou -> wou
if (is('å½±æ¯') && (is('æ¨¡éŸ»') || is('æ±éŸ»'))) {
    è²æ¯ = 'w'
}

// == éŸ»é ­è¦å‰‡ ==

// PyV > PV
if (is('å¹«çµ„ ä¸‰ç­‰') && éŸ»æ¯.startsWith('y')) {
    éŸ»æ¯ = éŸ»æ¯.slice(1)
}

// JwV > JV
if (is('ä»¥æ¯ åˆå£') && éŸ»æ¯.startsWith('w')) {
    éŸ»æ¯ = éŸ»æ¯.slice(1)
}


// == éŸ»æ¯è¦å‰‡ ==

// æ°´ swi > ã‚¹ã‚¤ ï½œ é¡ rwi > ãƒ«ã‚¤ |ã€€å° twi > ãƒ„ã‚¤
if (['s', 't', 'r'].includes(è²æ¯) && éŸ»æ¯ == 'wi') {
    éŸ»æ¯ = 'u' + éŸ»æ¯.slice(1)
}

if (éŸ»æ¯ == 'ii') {
    éŸ»æ¯ = 'yuu'
}

// == ç‰¹æ®Šå­—è¦å‰‡ ==
if (å­—é ­ == 'å¯§') {
    è²æ¯ = 'n'
}

// TODO: Clear up romaji before getting into ç‰‡å‡ååŒ–

function çµ„åˆè²éŸ»(è²æ¯, éŸ»æ¯) {
    if (!["0", "k", "g"].includes(è²æ¯) && éŸ»æ¯.startsWith("w"))
        éŸ»æ¯ = éŸ»æ¯.slice(1)

    if (è²æ¯ == "0" && éŸ»æ¯.startsWith("ye"))
        éŸ»æ¯ = éŸ»æ¯.slice(1)
    
    if (!é–‹é—œ.åˆ†mn && éŸ»æ¯.endsWith("m"))
        éŸ»æ¯ = éŸ»æ¯.slice(0, -1) + "n"

    if (!é–‹é—œ.wiwe && è²æ¯ != "0")
        éŸ»æ¯ = éŸ»æ¯.replace("wiy", "y").replace("wi", "i").replace("we", "e")

    return [è²æ¯, éŸ»æ¯].join("")
}

function ç‰‡å‡ååŒ–(æ‹‰ä¸è½‰å¯«) {
    const äº”åéŸ³ = {
        '0': {'a': 'ã‚¢', 'i': 'ã‚¤', 'u': 'ã‚¦', 'e': 'ã‚¨', 'o': 'ã‚ª'},
        'k': {'a': 'ã‚«', 'i': 'ã‚­', 'u': 'ã‚¯', 'e': 'ã‚±', 'o': 'ã‚³'},
        'g': {'a': 'ã‚¬', 'i': 'ã‚®', 'u': 'ã‚°', 'e': 'ã‚²', 'o': 'ã‚´'},
        's': {'a': 'ã‚µ', 'i': 'ã‚·', 'u': 'ã‚¹', 'e': 'ã‚»', 'o': 'ã‚½'},
        'z': {'a': 'ã‚¶', 'i': 'ã‚¸', 'u': 'ã‚º', 'e': 'ã‚¼', 'o': 'ã‚¾'},
        't': {'a': 'ã‚¿', 'i': 'ãƒ', 'u': 'ãƒ„', 'e': 'ãƒ†', 'o': 'ãƒˆ'},
        'd': {'a': 'ãƒ€', 'i': 'ãƒ‚', 'u': 'ãƒ…', 'e': 'ãƒ‡', 'o': 'ãƒ‰'},
        'n': {'a': 'ãƒŠ', 'i': 'ãƒ‹', 'u': 'ãƒŒ', 'e': 'ãƒ', 'o': 'ãƒ'},
        'f': {'a': 'ãƒ', 'i': 'ãƒ’', 'u': 'ãƒ•', 'e': 'ãƒ˜', 'o': 'ãƒ›'},
        'b': {'a': 'ãƒ', 'i': 'ãƒ“', 'u': 'ãƒ–', 'e': 'ãƒ™', 'o': 'ãƒœ'},
        'm': {'a': 'ãƒ', 'i': 'ãƒŸ', 'u': 'ãƒ ', 'e': 'ãƒ¡', 'o': 'ãƒ¢'},  
        'y': {'a': 'ãƒ¤', 'i': 'â—‹',  'u': 'ãƒ¦', 'e': 'ã‚¨', 'o': 'ãƒ¨'},
        'r': {'a': 'ãƒ©', 'i': 'ãƒª', 'u': 'ãƒ«', 'e': 'ãƒ¬', 'o': 'ãƒ­'},
        'w': {'a': 'ãƒ¯', 'i': 'ãƒ°', 'u': 'â—‹', 'e': 'ãƒ±', 'o': 'ãƒ²'},
    }

    let [wi, we] = é–‹é—œ.å°å‡åwiwe ? ['ğ›…¤', 'ğ›…¥'] : ['ãƒ°', 'ãƒ±']

    const å°å‡å = {
        'y': {'a': 'ãƒ£', 'i': 'â—‹', 'u': 'ãƒ¥', 'e': 'â—‹', 'o': 'ãƒ§'},
        'w': {'a': 'ãƒ®', 'i':  wi, 'u': 'â—‹', 'e':   we, 'o': 'ğ›…¦'},
    }

    if (!é–‹é—œ.å°å‡å) {
        å°å‡å['y'] = äº”åéŸ³['y']
        å°å‡å['w'] = äº”åéŸ³['w']
    }

    // äºŒåˆæ‹—éŸ³ï¼šwiyau > ğ›…¤ãƒ£ã‚¦
    if (æ‹‰ä¸è½‰å¯«.endsWith('wiyau'))
        return `${äº”åéŸ³[æ‹‰ä¸è½‰å¯«[0]]['u']}${é–‹é—œ.å°å‡åwiwe ? 'ğ›…¤ãƒ£' : 'ãƒ°ãƒ¤'}ã‚¦`

    // CVVCV > CV.V.CV
    // Ref: https://stackoverflow.com/a/49407494/2719898
    const éŸ³ç¯€æ­£å‰‡ = /[^aeiou]*[wy]?[aeioumn](?:$|[^aeiou](?=[^aeiou]))?/gi;

    éŸ³ç¯€åˆ—è¡¨ = æ‹‰ä¸è½‰å¯«.match(éŸ³ç¯€æ­£å‰‡)

    å‡ååˆ—è¡¨ = éŸ³ç¯€åˆ—è¡¨.map((éŸ³ç¯€) => {
        if (éŸ³ç¯€.length == 3) {
            // CGV := CyV / CwV 
            let [C, G, V] = éŸ³ç¯€;

            const GtoV = {
                'y': 'i',
                'w': 'u'
            }

            if (C == '0')
                return äº”åéŸ³[G][V]
            if (å°å‡å[G][V] == 'â—‹')
                return äº”åéŸ³[C][V]
            if (!['k', 'g'].includes(C) && G == 'w')
                return äº”åéŸ³[C][V]

            return äº”åéŸ³[C][GtoV[G]] + å°å‡å[G][V]
        }

        const C = éŸ³ç¯€.length == 2 ? éŸ³ç¯€[0] : '0'
        const V = éŸ³ç¯€.slice(-1)

        if (V.match(/[aiueo]/)) {
            return äº”åéŸ³[C][V]
        } else if (V == 'n') {
            return 'ãƒ³'
        } else if (V == 'm') {
            return 'ãƒ '
        } else {
            throw new Error(`æœªçŸ¥è¦å‰‡éŸ³ç¯€ï¼š ${éŸ³ç¯€}`);
        }
    })

    return å‡ååˆ—è¡¨.join('')
}

const æ‹‰ä¸è½‰å¯« = çµ„åˆè²éŸ»(è²æ¯, éŸ»æ¯)

// return `${ç‰‡å‡ååŒ–(æ‹‰ä¸è½‰å¯«)} (${æ‹‰ä¸è½‰å¯«.replace("0", "")})`
return é–‹é—œ.å‡å ? ç‰‡å‡ååŒ–(æ‹‰ä¸è½‰å¯«) : æ‹‰ä¸è½‰å¯«.replace("0", "");
